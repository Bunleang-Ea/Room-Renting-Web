<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management System</title>
    <style>
        body { font-family: 'Segoe UI', 'BATTAMBANG', sans-serif; background: #eef2f3; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #dcdde1; width: 100%; max-width: 1100px; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: none; font-weight: bold; font-size: 16px; color: #7f8c8d; transition: 0.3s; }
        .tab-btn.active { color: #3498db; border-bottom: 4px solid #3498db; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .grid-three { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        label { font-size: 15px; color: #34495e; font-weight: bold; display: block; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #dcdde1; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        .info-table { width: 100%; border-collapse: collapse; margin-top: 30px; background: #fafbfc; }
        .info-table th, .info-table td { border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 14px; }
        .info-table th { background: #e8f0fe; color: #2c3e50; }
        .btn-group { display: flex; gap: 20px; margin-top: 35px; justify-content: center; }
        button { padding: 16px 40px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 18px; color: white; min-width: 200px; }
        #saveBtn, #saveUtilBtn, #payBtn { background: #3498db; }
        #updateBtn { background: #27ae60; }
        #clearBtn, #clearUtilBtn, #clearPayBtn { background: #95a5a6; }
        .btn-end { background: #c0392b !important; }
        button:disabled { background: #bdc3c7 !important; cursor: not-allowed; }
        .btn-rented { background: #e74c3c !important; cursor: not-allowed; }
        .header-title { text-align: center; color: #2c3e50; margin-bottom: 25px; border-bottom: 3px solid #3498db; padding-bottom: 15px; font-size: 24px; }
        .search-box { margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        .readonly-input { background: #f1f2f6; color: #7f8c8d; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="openTab(event, 'tenantTab')">Tenant Entry</button>
    <button class="tab-btn" onclick="openTab(event, 'utilityTab')">Add Water_Electricity</button>
    <button class="tab-btn" onclick="openTab(event, 'paidTab')">Paid Form</button>
</div>

<div id="tenantTab" class="tab-content active">
    <div class="card">
        <h2 class="header-title">á”á‰áŸ’á…á¼á›á‘á·á“áŸ’á“á“áŸá™á¢áŸ’á“á€á‡á½á›ááŸ’á˜á¸</h2>
        <div class="search-box">
            <label>ğŸ” áŸáŸ’áœáŸ‚á„ášá€á¢áŸ’á“á€á‡á½á›áŠá¾á˜áŸ’á”á¸á€áŸ‚á”áŸ’ášáŸ‚ (Search Tenant to Edit):</label>
            <select id="searchTenantSelect" onchange="searchTenant(this.value)">
                <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡ (Select Name) --</option>
            </select>
        </div>
        <form id="rentForm">
            <div class="grid-container">
                <div>
                    <label>áˆáŸ’á˜áŸ„áŸ‡ á¢áŸ’á“á€á‡á½á›</label>
                    <input type="text" id="name" required>
                    <label>á›áŸáá‘áŸ†á“á¶á€áŸ‹á‘áŸ†á“á„</label>
                    <input type="tel" id="contact" required>
                    <label>Telegram</label>
                    <input type="text" id="telegram">
                    <label>á¢ááŸ’ááŸá‰áŸ’á‰á¶áá”áŸááŸ’á (Gov ID)</label>
                    <input type="text" id="gov_id">
                    <label>áá˜áŸ’á›áŸƒá”á“áŸ’á‘á”áŸ‹ ($)</label>
                    <input type="number" id="room_price">
                    <label>á¢áŸ†áá¶á“á…á¶áŸáŸ‹ (á‘á¹á€)</label>
                    <input type="number" id="old_water" placeholder="Start Reading">
                    <label>áá˜áŸ’á›áŸƒá‘á¹á€/mÂ³ (áŸ›)</label>
                    <input type="number" id="water_rate">
                    <label>á”áŸ’ášá¶á€áŸ‹á€á€áŸ‹ ($)</label>
                    <input type="number" id="deposit">
                </div>
                <div>
                    <label>á›áŸáá”á“áŸ’á‘á”áŸ‹</label>
                    <select id="room" required><option value="">-- á‡áŸ’ášá¾áŸášá¾áŸ --</option></select>
                    <label>ááŸ’á„áŸƒá…á»áŸ‡á€á»á„ááŸ’ášá¶</label>
                    <input type="date" id="contract_date" required>
                    <label>á‡á˜áŸ’ášá¾áŸá€á»á„ááŸ’ášá¶ (ááŸ‚)</label>
                    <input type="number" id="contract_term">
                    <label>ááŸ’á„áŸƒá…á¼á›áŸáŸ’á“á¶á€áŸ‹á“áŸ…</label>
                    <input type="date" id="start_date" required>
                    <label>á¢áŸ†áá¶á“á…á¶áŸáŸ‹ (á—áŸ’á›á¾á„)</label>
                    <input type="number" id="old_electric" placeholder="Start Reading">
                    <label>áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„/kwh (áŸ›)</label>
                    <input type="number" id="electric_rate">
                    <label>ááŸ’á›áŸƒáŸá˜áŸ’ášá¶á˜ (áŸ›)</label>
                    <input type="number" id="garbage_fee">
                </div>
            </div>
            <table class="info-table" id="infoGrid">
                <thead><tr><th>á›áŸáá”á“áŸ’á‘á”áŸ‹</th><th>á‡á¶á“áŸ‹</th><th>á¢á‚á¶áš</th><th>áŸáŸ’áá¶á“á—á¶á–</th></tr></thead>
                <tbody><tr><td id="td_room">-</td><td id="td_floor">-</td><td id="td_building">-</td><td id="td_status">-</td></tr></tbody>
                <thead><tr><th>áá˜áŸ’á›áŸƒá‡á½á›</th><th>á‘á¹á€/mÂ³</th><th>á—áŸ’á›á¾á„/kwh</th><th>ááŸ’á›áŸƒáŸá˜áŸ’ášá¶á˜</th></tr></thead>
                <tbody><tr><td id="td_price">-</td><td id="td_water">-</td><td id="td_electric">-</td><td id="td_garbage">-</td></tr></tbody>
                <thead><tr><th colspan="4">á”áŸ’ášá¶á€áŸ‹á€á€áŸ‹</th></tr></thead>
                <tbody><tr><td colspan="4" id="td_deposit">-</td></tr></tbody>
            </table>
            <div class="btn-group">
                <button type="button" id="saveBtn">ášá€áŸ’áŸá¶á‘á»á€ (Save)</button>
                <button type="button" id="updateBtn" disabled>á€áŸ‚á”áŸ’ášáŸ‚ (Update)</button>
                <button type="button" id="clearBtn">áŸá˜áŸ’á¢á¶á (Clear)</button>
            </div>
        </form>
    </div>
</div>

<div id="utilityTab" class="tab-content">
    <div class="card">
        <h2 class="header-title">á‘á˜áŸ’ášá„áŸ‹á”á‰áŸ’á…á¼á›á‘á·á“áŸ’á“á“áŸá™ á€á¶ášá”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á‘á¹á€ á“á·á„á—áŸ’á›á¾á„</h2>
        <form id="utilityForm">
            <label>áˆáŸ’á˜áŸ„áŸ‡ á¢áŸ’á“á€á‡á½á›/á›áŸáá”á“áŸ’á‘á”áŸ‹</label>
            <select id="util_tenant_select" required onchange="fillTenantData()">
                <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸá¢áŸ’á“á€á‡á½á› --</option>
            </select>
            <div class="grid-three">
                <div><label>áˆáŸ’á˜áŸ„áŸ‡ á¢áŸ’á“á€á‡á½á›</label><input type="text" id="util_name" class="readonly-input" readonly></div>
                <div><label>á›áŸáá”á“áŸ’á‘á”áŸ‹</label><input type="text" id="util_room" class="readonly-input" readonly></div>
                <div><label>áá˜áŸ’á›áŸƒá”á“áŸ’á‘á”áŸ‹</label><input type="text" id="util_price" class="readonly-input" readonly></div>
            </div>
            <div class="grid-three">
                <div><label>ááŸ’á„áŸƒá…á¶á”áŸ‹á•áŸ’áŠá¾á˜</label><input type="date" id="util_start_date" class="readonly-input" readonly></div>
                <div><label>á¢áŸ†áá¶á“á…á¶áŸáŸ‹ (á‘á¹á€)</label><input type="number" id="util_old_water" class="readonly-input" readonly></div>
                <div><label>áá˜áŸ’á›áŸƒá‘á¹á€/mÂ³</label><input type="number" id="util_water_rate" class="readonly-input" readonly></div>
            </div>
            <div class="grid-three">
                <div><label>á¢áŸ†áá¶á“á…á¶áŸáŸ‹ (á—áŸ’á›á¾á„)</label><input type="number" id="util_old_electric" class="readonly-input" readonly></div>
                <div><label>áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„/kwh</label><input type="number" id="util_electric_rate" class="readonly-input" readonly></div>
                <div><label>ááŸ’á›áŸƒáŸá˜áŸ’ášá¶á˜</label><input type="number" id="util_garbage" class="readonly-input" readonly></div>
            </div>
            <div class="grid-three">
                <div><label>ááŸ’á„áŸƒá”á‰áŸ’á…á”áŸ‹</label><input type="date" id="util_end_date"></div>
                <div><label>á¢áŸ†áá¶á“ááŸ’á˜á¸ (á‘á¹á€)</label><input type="number" id="util_new_water"></div>
                <div><label>á¢áŸ†áá¶á“ááŸ’á˜á¸ (á—áŸ’á›á¾á„)</label><input type="number" id="util_new_electric"></div>
            </div>
            <label>áŸá˜áŸ’á—á¶ášáŸˆáá¼á…áá¶á ($) (Optional)</label>
            <input type="number" id="util_damage" value="0">
            <div class="btn-group">
                <button type="button" id="saveUtilBtn">ášá€áŸ’áŸá¶á‘á»á€ (Save)</button>
                <button type="button" id="clearUtilBtn">áŸá˜áŸ’á¢á¶á (Clear)</button>
            </div>
        </form>
    </div>
</div>

<div id="paidTab" class="tab-content">
    <div class="card">
        <h2 class="header-title">á‘á˜áŸ’ášá„áŸ‹á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹ (Payment Form)</h2>
        <form id="paidForm">
            <div class="grid-container">
                <div>
                    <label>áˆáŸ’á˜áŸ„áŸ‡ á¢áŸ’á“á€á‡á½á›/á›áŸáá”á“áŸ’á‘á”áŸ‹ (Select Tenant)</label>
                    <select id="pay_tenant_select" required onchange="fillPayData()">
                        <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸá¢áŸ’á“á€á‡á½á› --</option>
                    </select>
                </div>
                <div>
                    <label>á€á¶ášá”á„áŸ‹á›á¾á€á‘á¸ (Payment No)</label>
                    <input type="text" id="pay_invoice_no"> </div>
            </div>

            <div class="grid-three">
                <div><label>áˆáŸ’á˜áŸ„áŸ‡ á¢áŸ’á“á€á‡á½á›</label><input type="text" id="pay_name" class="readonly-input" readonly></div>
                <div><label>á›áŸáá”á“áŸ’á‘á”áŸ‹</label><input type="text" id="pay_room" class="readonly-input" readonly></div>
                <div><label>áá˜áŸ’á›áŸƒá”á“áŸ’á‘á”áŸ‹</label><input type="text" id="pay_room_price" class="readonly-input" readonly></div>
            </div>
            <div class="grid-three">
                <div><label>ááŸ’á„áŸƒá‘á¸á•áŸ’áá¾á˜</label><input type="text" id="pay_start_date" class="readonly-input" readonly></div>
                <div><label>ááŸ’á„áŸƒá‘á¸á”á‰áŸ’á…á”áŸ‹</label><input type="text" id="pay_end_date" class="readonly-input" readonly></div>
                <div><label>áŸášá»á”ááŸ’ášá¼áœá”á„áŸ‹ ($)</label><input type="text" id="pay_total_usd" class="readonly-input" style="font-weight:bold; color:#e74c3c;" readonly></div>
            </div>
            <div class="grid-three">
                <div><label>áŸášá»á”ááŸ’ášá¼áœá”á„áŸ‹ (áŸ›)</label><input type="text" id="pay_total_riel" class="readonly-input" style="font-weight:bold; color:#e74c3c;" readonly></div>
                <div></div> <div></div> </div>

            <hr style="margin: 25px 0; border: 0; border-top: 1px solid #ddd;">

            <div class="grid-three">
                <div>
                    <label>á”á„áŸ‹á‡á¶á€áŸ‹áŸáŸ’ááŸ‚á„ (áŸ›)</label>
                    <input type="number" id="pay_actual_riel" placeholder="0">
                </div>
                <div>
                    <label>á”á„áŸ‹á‡á¶á€áŸ‹áŸáŸ’ááŸ‚á„ ($)</label>
                    <input type="number" id="pay_actual_usd" placeholder="0.00">
                </div>
                <div>
                    <label>ášá”áŸ€á”á”á„áŸ‹</label>
                    <select id="pay_method" onchange="toggleBank(this.value)">
                        <option value="">-- Select --</option> <option value="Cash">Cash (áŸá¶á…áŸ‹á”áŸ’ášá¶á€áŸ‹)</option>
                        <option value="Bank">Bank (á’á“á¶á‚á¶áš)</option>
                    </select>
                </div>
            </div>

            <div class="grid-three">
                <div>
                    <label>á’á“á¶á‚á¶áš (Bank Name)</label>
                    <select id="pay_bank" disabled>
                        <option value="">-- None --</option>
                        <option value="ABA">ABA Bank</option>
                        <option value="Acleda">Acleda Bank</option>
                        <option value="Wing">Wing Bank</option>
                    </select>
                </div>
                <div>
                    <label>ááŸ’á„áŸƒá‘á¸á”á„áŸ‹ (Paid Date)</label>
                    <input type="date" id="pay_date" required> </div>
                <div>
                    <label>á”ášá·á™á¶á™ (Description/Note)</label>
                    <input type="text" id="pay_note">
                </div>
            </div>

            <div class="btn-group">
                <button type="button" id="payBtn">Paid (á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹)</button>
                <button type="button" class="btn-end">Ended (á”á‰áŸ’á…á”áŸ‹)</button>
            </div>
        </form>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbz0_3M1fQ7Q08qG0LeQTHvl0wEM0mqrOTXiHgR7_l3inuUwVuo9-uf6C8AklwQcCJU/exec'; // <--- PASTE YOUR URL HERE
    let globalTenants = [];

    function openTab(evt, tabName) {
        let content = document.getElementsByClassName("tab-content");
        for (let i = 0; i < content.length; i++) content[i].classList.remove("active");
        let links = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < links.length; i++) links[i].classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    window.onload = () => {
        // Load Rooms
        fetch(`${scriptURL}?action=getRooms`).then(res => res.json()).then(data => {
            data.forEach(r => document.getElementById('room').add(new Option(r, r)));
        });
        
        // Load Tenants
        fetch(`${scriptURL}?action=getTenants`).then(res => res.json()).then(data => {
            globalTenants = data;
            const utilSelect = document.getElementById('util_tenant_select');
            const searchSelect = document.getElementById('searchTenantSelect');
            const paySelect = document.getElementById('pay_tenant_select');
            
            data.forEach(t => {
                let optLabel = t.label;
                let optVal = t.name + "|" + t.room;
                
                utilSelect.add(new Option(t.label, t.name));
                searchSelect.add(new Option(optLabel, optVal));
                paySelect.add(new Option(optLabel, optVal));
            });
        });
    };

    // --- PAID FORM LOGIC ---
    function toggleBank(method) {
        const bankSelect = document.getElementById('pay_bank');
        if (method === 'Bank') {
            bankSelect.disabled = false;
            bankSelect.required = true;
        } else {
            bankSelect.disabled = true;
            bankSelect.value = "";
            bankSelect.required = false;
        }
    }

    function fillPayData() {
        const val = document.getElementById('pay_tenant_select').value;
        if(!val) return;
        const [name, room] = val.split("|");

        fetch(`${scriptURL}?action=getPaymentDetails&room=${encodeURIComponent(room)}`)
        .then(res => res.json())
        .then(data => {
            if(data.error) { alert(data.error); return; }
            
            document.getElementById('pay_name').value = data.name;
            document.getElementById('pay_room').value = data.room;
            document.getElementById('pay_room_price').value = "$" + data.price;
            document.getElementById('pay_start_date').value = data.start_date;
            document.getElementById('pay_end_date').value = data.end_date;
            
            document.getElementById('pay_total_riel').value = new Intl.NumberFormat('km-KH', { style: 'currency', currency: 'KHR' }).format(data.total_riel);
            document.getElementById('pay_total_usd').value = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(data.total_usd);
            
            // REMOVED: Auto-set payment date to today
        });
    }

    document.getElementById('payBtn').onclick = () => {
        const val = document.getElementById('pay_tenant_select').value;
        if(!val) { alert("Please select a tenant."); return; }
        const [name, room] = val.split("|");

        const payload = {
            action: 'submitPayment',
            room_no: room,
            invoice_no: document.getElementById('pay_invoice_no').value, // Now sends invoice no
            pay_date: document.getElementById('pay_date').value,
            actual_riel: document.getElementById('pay_actual_riel').value,
            actual_usd: document.getElementById('pay_actual_usd').value,
            method: document.getElementById('pay_method').value,
            bank: document.getElementById('pay_bank').value,
            note: document.getElementById('pay_note').value
        };
        sendData(payload, 'payBtn');
    };

    // --- OTHER LOGIC (UNCHANGED) ---
    function fillTenantData() {
        const selectedName = document.getElementById('util_tenant_select').value;
        const tenant = globalTenants.find(t => t.name === selectedName);
        if (tenant) {
            document.getElementById('util_name').value = tenant.name;
            document.getElementById('util_room').value = tenant.room;
            document.getElementById('util_price').value = "$" + tenant.price;
            document.getElementById('util_start_date').value = tenant.startDate;
            document.getElementById('util_old_water').value = tenant.oldWater;
            document.getElementById('util_old_electric').value = tenant.oldElectric;
            fetch(`${scriptURL}?room=${tenant.room}`).then(res => res.json()).then(data => {
                document.getElementById('util_water_rate').value = data.waterRate;
                document.getElementById('util_electric_rate').value = data.electricRate;
                document.getElementById('util_garbage').value = data.garbageRate;
            });
        }
    }
    
    function searchTenant(value) {
        if(!value) return;
        const [name, room] = value.split("|");
        fetch(`${scriptURL}?action=getTenantDetails&name=${encodeURIComponent(name)}&room=${encodeURIComponent(room)}`)
        .then(res => res.json()).then(data => {
            if(data.error) { alert("Tenant not found"); return; }
            document.getElementById('name').value = data.name;
            document.getElementById('contact').value = data.contact;
            document.getElementById('telegram').value = data.telegram;
            document.getElementById('gov_id').value = data.gov_id;
            document.getElementById('room_price').value = data.room_price;
            document.getElementById('water_rate').value = data.water_rate;
            document.getElementById('electric_rate').value = data.electric_rate;
            document.getElementById('garbage_fee').value = data.garbage_fee;
            document.getElementById('deposit').value = data.deposit;
            document.getElementById('contract_date').value = data.contract_date;
            document.getElementById('contract_term').value = data.contract_term;
            document.getElementById('start_date').value = data.start_date;
            document.getElementById('old_water').value = data.old_water;
            document.getElementById('old_electric').value = data.old_electric;
            const roomSelect = document.getElementById('room');
            for(let i=0; i<roomSelect.options.length; i++) {
                if(roomSelect.options[i].value.indexOf(data.room_no) === 0) {
                    roomSelect.selectedIndex = i;
                    const roomID = roomSelect.value.split(' ')[0];
                    fetch(`${scriptURL}?room=${roomID}`).then(res => res.json()).then(rData => {
                        document.getElementById('td_room').innerText = rData.roomNo;
                        document.getElementById('td_floor').innerText = rData.floor;
                        document.getElementById('td_building').innerText = rData.building;
                        document.getElementById('td_status').innerText = rData.status;
                        document.getElementById('td_price').innerText = "$" + rData.price;
                        document.getElementById('td_water').innerText = rData.waterRate + " áŸ›";
                        document.getElementById('td_electric').innerText = rData.electricRate + " áŸ›";
                        document.getElementById('td_garbage').innerText = rData.garbageRate + " áŸ›";
                        document.getElementById('td_deposit').innerText = "$" + rData.deposit;
                        document.getElementById('saveBtn').disabled = true;
                        document.getElementById('saveBtn').innerText = "Rented (á‡á½á›)";
                        document.getElementById('saveBtn').classList.add('btn-rented');
                        document.getElementById('updateBtn').disabled = false;
                        document.getElementById('updateBtn').classList.remove('btn-rented');
                    });
                    break;
                }
            }
        });
    }

    document.getElementById('room').onchange = function() {
        const roomID = this.value.split(' ')[0];
        fetch(`${scriptURL}?room=${roomID}`).then(res => res.json()).then(data => {
            document.getElementById('td_room').innerText = data.roomNo;
            document.getElementById('td_floor').innerText = data.floor;
            document.getElementById('td_building').innerText = data.building;
            document.getElementById('td_status').innerText = data.status;
            document.getElementById('td_price').innerText = "$" + data.price;
            document.getElementById('td_water').innerText = data.waterRate + " áŸ›";
            document.getElementById('td_electric').innerText = data.electricRate + " áŸ›";
            document.getElementById('td_garbage').innerText = data.garbageRate + " áŸ›";
            document.getElementById('td_deposit').innerText = "$" + data.deposit;
            document.getElementById('room_price').value = data.price;
            document.getElementById('water_rate').value = data.waterRate;
            document.getElementById('electric_rate').value = data.electricRate;
            document.getElementById('garbage_fee').value = data.garbageRate;
            document.getElementById('deposit').value = data.deposit;
            const saveBtn = document.getElementById('saveBtn');
            const updateBtn = document.getElementById('updateBtn');
            if (data.status === "á‡á½á›") {
                saveBtn.innerText = "Rented (á‡á½á›)";
                saveBtn.classList.add('btn-rented');
                saveBtn.disabled = true;
                updateBtn.disabled = false;
            } else {
                saveBtn.innerText = "ášá€áŸ’áŸá¶á‘á»á€ (Save)";
                saveBtn.classList.remove('btn-rented');
                saveBtn.disabled = false;
                updateBtn.disabled = true;
            }
        });
    };

    function getFormData(action) {
        return {
            action: action,
            name: document.getElementById('name').value,
            contact: document.getElementById('contact').value,
            telegram: document.getElementById('telegram').value,
            gov_id: document.getElementById('gov_id').value,
            room_no: document.getElementById('room').value.split(' ')[0],
            room_price: document.getElementById('room_price').value,
            deposit: document.getElementById('deposit').value,
            water_rate: document.getElementById('water_rate').value,
            electric_rate: document.getElementById('electric_rate').value,
            garbage_fee: document.getElementById('garbage_fee').value,
            contract_date: document.getElementById('contract_date').value,
            contract_term: document.getElementById('contract_term').value,
            start_date: document.getElementById('start_date').value,
            old_water: document.getElementById('old_water').value,
            old_electric: document.getElementById('old_electric').value
        };
    }

    document.getElementById('saveBtn').onclick = () => sendData(getFormData('save'), 'saveBtn');
    document.getElementById('updateBtn').onclick = () => sendData(getFormData('update'), 'updateBtn');

    document.getElementById('saveUtilBtn').onclick = () => {
        const payload = {
            action: 'addUtility',
            name: document.getElementById('util_name').value,
            room_no: document.getElementById('util_room').value,
            start_date: document.getElementById('util_start_date').value,
            end_date: document.getElementById('util_end_date').value,
            old_water: document.getElementById('util_old_water').value,
            new_water: document.getElementById('util_new_water').value,
            old_electric: document.getElementById('util_old_electric').value,
            new_electric: document.getElementById('util_new_electric').value,
            damage: document.getElementById('util_damage').value
        };
        sendData(payload, 'saveUtilBtn');
    };

    function sendData(payload, btnId) {
        const btn = document.getElementById(btnId);
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Processing...";
        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => { alert("Success!"); location.reload(); })
            .catch(() => { alert("Error!"); btn.disabled = false; btn.innerText = originalText; });
    }

    document.getElementById('clearBtn').onclick = () => location.reload();
    document.getElementById('clearUtilBtn').onclick = () => location.reload();
</script>
</body>
</html>
